library(shiny)
library(DT)  # Do obsługi dynamicznych tabel

# Funkcja do obliczania kwantyli dla danych
calculate_quantiles <- function(data) {
  quantile_values <- seq(0, 1, by = 0.1)
  quantiles <- sapply(quantile_values, function(q) quantile(data, probs = q, na.rm = TRUE))
  return(quantiles)
}

# Załaduj dane ubezpieczycieli
loaded_data <- list(
  AXA = data.frame(Brutto = 300*rnorm(1000), Netto = 300*rnorm(1000)),
  PZU = data.frame(Brutto = 500*rnorm(1000), Netto = 500*rnorm(1000)),
  UNIQA = data.frame(Brutto_Katastoficzny = 1009*rnorm(1000), Netto_Katastoficzny = 1009*rnorm(1000))
)

# Załaduj dane porównania SF/IM
loaded_data_porownanie <- data.frame(
  Ubezpieczyciel = c("AXA", "PZU", "UNIQA"),
  Brutto = c(0, 500, 1009),
  Netto = c(300, 500, 1009)
)

# Funkcja do formatowania liczb jako całkowite
format_numbers <- function(x) {
  return(formatC(round(x), format = "f", big.mark = " "))  # Zaokrąglamy liczbę do całkowitej przed formatowaniem
}

# UI aplikacji Shiny
ui <- fluidPage(
  titlePanel("Tabela Kwantyli - Ubezpieczyciele"),
  
  sidebarLayout(
    sidebarPanel(
      uiOutput("column_selector"),   # Dynamiczny wybór kolumny do analizy
      actionButton("generate_table", "Generuj Tabelę Kwantyli") # Przycisk generowania tabeli
    ),
    
    mainPanel(
      tabsetPanel(
        # Główna zakładka "Tabela Kwantyli"
        tabPanel("Tabela Kwantyli", 
                 DTOutput("quantile_table")),  # Dynamiczna tabela kwantyli
        
        # Zakładka "Porównanie SF/IM"
        tabPanel("Porównanie SF/IM", 
                 DTOutput("diff_table")),  # Zakładka porównawcza
        
      )
    )
  )
)

# Server aplikacji Shiny
server <- function(input, output, session) {
  
  # Dynamiczne generowanie wyboru kolumny w zależności od wybranego ubezpieczyciela
  output$column_selector <- renderUI({
    # Listowanie wszystkich dostępnych kolumn dla ubezpieczycieli
    colnames <- unique(unlist(lapply(loaded_data, colnames)))
    selectInput("column", "Wybierz kolumnę do analizy:", choices = colnames)
  })
  
  # Funkcja generująca tabelę kwantyli
  observeEvent(input$generate_table, {
    selected_column <- input$column
    
    # Przechowujemy kwantyle dla wszystkich ubezpieczycieli
    quantiles_data <- data.frame(Ubezpieczyciel = character(), stringsAsFactors = FALSE)
    
    for (insurer in names(loaded_data)) {
      # Pobieramy dane z wybranej kolumny dla każdego ubezpieczyciela
      data <- loaded_data[[insurer]][[selected_column]]
      
      # Obliczamy kwantyle
      quantiles <- calculate_quantiles(data)
      
      # Dodajemy kwantyle do tabeli
      quantiles_data <- rbind(quantiles_data, data.frame(Ubezpieczyciel = insurer, t(quantiles)))
    }
    
    # Ustawiamy odpowiednie nazwy kolumn
    colnames(quantiles_data)[2:ncol(quantiles_data)] <- paste0("Q", seq(0, 1, by = 0.1))
    
    # Formatujemy wartości liczbowe w tabeli
    quantiles_data[2:ncol(quantiles_data)] <- lapply(quantiles_data[2:ncol(quantiles_data)], function(x) format_numbers(as.numeric(x)))
    
    # Wyświetlanie tabeli
    output$quantile_table <- renderDT({
      datatable(quantiles_data, options = list(pageLength = 10))
    })
  })
  
  # Funkcja do obliczania różnicy pomiędzy kwantylem 0.995 a średnią
  observeEvent(input$generate_table, {
    diff_data <- data.frame(Ubezpieczyciel = character(), Brutto = numeric(), Netto = numeric(), Różnice_Brutto = numeric(), Różnice_Netto = numeric(), stringsAsFactors = FALSE)
    
    for (insurer in names(loaded_data)) {
      # Pobieramy dane dla każdego ubezpieczyciela
      data_brutto <- loaded_data[[insurer]]$Brutto
      data_netto <- loaded_data[[insurer]]$Netto
      
      # Obliczamy kwantyl 0.995 i średnią
      quantile_brutto <- quantile(data_brutto, probs = 0.995, na.rm = TRUE)
      quantile_netto <- quantile(data_netto, probs = 0.995, na.rm = TRUE)
      
      mean_brutto <- mean(data_brutto, na.rm = TRUE)
      mean_netto <- mean(data_netto, na.rm = TRUE)
      
      # Jeśli wartość w loaded_data_porownanie = 0, nie obliczamy
      if (loaded_data_porownanie$Brutto[loaded_data_porownanie$Ubezpieczyciel == insurer] == 0) {
        diff_brutto <- NA
      } else {
        diff_brutto <- (loaded_data_porownanie$Brutto[loaded_data_porownanie$Ubezpieczyciel == insurer] - quantile_brutto) / loaded_data_porownanie$Brutto[loaded_data_porownanie$Ubezpieczyciel == insurer]
      }
      
      if (loaded_data_porownanie$Netto[loaded_data_porownanie$Ubezpieczyciel == insurer] == 0) {
        diff_netto <- NA
      } else {
        diff_netto <- (loaded_data_porownanie$Netto[loaded_data_porownanie$Ubezpieczyciel == insurer] - quantile_netto) / loaded_data_porownanie$Netto[loaded_data_porownanie$Ubezpieczyciel == insurer]
      }
      
      # Dodajemy do tabeli
      diff_data <- rbind(diff_data, data.frame(Ubezpieczyciel = insurer, Brutto = quantile_brutto, Netto = quantile_netto, Różnice_Brutto = diff_brutto, Różnice_Netto = diff_netto))
    }
    
    # Formatujemy tabelę
    diff_data$Różnice_Brutto <- sapply(diff_data$Różnice_Brutto, function(x) ifelse(is.na(x), "", format_numbers(x)))
    diff_data$Różnice_Netto <- sapply(diff_data$Różnice_Netto, function(x) ifelse(is.na(x), "", format_numbers(x)))
    
    # Stylowanie komórek w zależności od wartości
    output$diff_table <- renderDT({
      datatable(diff_data, options = list(pageLength = 10)) %>%
        formatStyle(
          'Różnice_Brutto', 
          color = styleInterval(0, c('red', 'green'))
        ) %>%
        formatStyle(
          'Różnice_Netto', 
          color = styleInterval(0, c('red', 'green'))
        )
    })
  })
}

# Uruchomienie aplikacji
shinyApp(ui = ui, server = server)
