library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
library(openxlsx)
library(sf)
# Funkcja do wczytywania danych o szkodach i obiektach oraz generowania map
wczytaj_i_generuj_mapy <- function(sciezka_glowna) {
  
  # Wczytaj plik CSV ze szkodami
  dane_szkody <- read.csv2(file.path(sciezka_glowna, "Szkody_final.csv"),encoding  = "UTF-8",header=TRUE)
  dim(dane_szkody)
  # Przechodzimy przez wszystkie foldery ubezpieczycieli
  lista_folderow <- list.dirs(sciezka_glowna, full.names = TRUE, recursive = FALSE)
  
  # Utwórz nowy workbook Excel
  workbook <- createWorkbook()
  
  # Pobierz mapę Polski z konturami kraju
  poland <- ne_countries(scale = "medium", country = "Poland", returnclass = "sf")
  poland <- st_transform(poland, crs = 4326)
  
  # Iteracja przez foldery ubezpieczycieli
  for (folder in lista_folderow) {
    
    sciezka_csv <- list.files(folder, pattern = "_final\\.csv$", full.names = TRUE)
    nazwa_ubezpieczyciela <- basename(folder)
    nazwa_ubezpieczyciela <- sub("^\\d+\\s+", "", nazwa_ubezpieczyciela)  # Usuwa liczby na początku
    folder_wewnetrzny <- file.path(folder, nazwa_ubezpieczyciela)
    sciezka_csv<- paste0(folder_wewnetrzny,"/",nazwa_ubezpieczyciela,"_final.csv")
    
    if (length(sciezka_csv) == 1) {
      # Wczytaj dane o obiektach
      dane_obiekty <- read.csv2(sciezka_csv,encoding  = "UTF-8",header=TRUE)[, c("Szerokosc", "Dlugosc"),]
      
      # Wyciągnij nazwę ubezpieczyciela z nazwy pliku (np. "PZU" z "PZU_final.csv")
      nazwa_ubezpieczyciela <- sub("_final\\.csv$", "", basename(sciezka_csv))
      
      # Filtruj dane_szkody dla danego ubezpieczyciela
      dane_szkody_filtr <- subset(dane_szkody, ReasekuracjaO == nazwa_ubezpieczyciela)
      
      dane_obiekty <- st_as_sf(dane_obiekty, coords = c("Dlugosc", "Szerokosc"), crs = 4326)
      dane_szkody <- st_as_sf(dane_szkody, coords = c("Dlugosc", "Szerokosc"), crs = 4326)
      
      dane_szkody_filtr <- st_as_sf(dane_szkody_filtr, coords = c("Dlugosc", "Szerokosc"), crs = 4326)
      map_all_damage <- ggplot() +
        geom_sf(data = poland, fill = "lightyellow", color = "darkblue", size = 0.5) +
        geom_sf(data = dane_obiekty, color = "black", size = 0.05) +
        geom_sf(data = dane_szkody, color = "red", shape = 4, size = 0.05) +  # Krzyżyki dla szkód
        theme_classic() +
        theme(plot.title = element_text(hjust = 0.5, margin = margin(b = 10))) +
        labs(
          title = paste("Mapa obiektów ubezpieczonych ubezpieczyciela", nazwa_ubezpieczyciela, "i szkody wszystkich ubezpieczycieli"),
          x = "Długość geograficzna", y = "Szerokość geograficzna"
        ) +
        coord_sf(lims_method = "geometry_bbox")
      # Zapisz mapę ogólną do pliku tymczasowego
      temp_file_all <- tempfile(fileext = ".png")
      ggsave(temp_file_all, plot = map_all_damage, width = 6, height = 5, dpi = 300)
      # Tworzenie mapy specyficznej (budynki i szkody tylko dla tego ubezpieczyciela)
      map_specific_damage <- ggplot() +
        geom_sf(data = poland, fill = "lightyellow", color = "darkblue", size = 0.5) +
        geom_sf(data = dane_obiekty, color = "black", size = 0.05) +
        geom_sf(data = dane_szkody_filtr, color = "red", shape = 4, size = 0.05) +  # Krzyżyki dla szkód
        theme_classic() +
        theme(plot.title = element_text(hjust = 0.5, margin = margin(b = 10))) +
        labs(
          title = paste("Mapa obiektów ubezpieczonych i szkód ubezpieczyciela", nazwa_ubezpieczyciela),
          x = "Długość geograficzna", y = "Szerokość geograficzna"
        ) +
        coord_sf(lims_method = "geometry_bbox")
      # Zapisz mapę specyficzną do pliku tymczasowego
      temp_file_specific <- tempfile(fileext = ".png")
      ggsave(temp_file_specific, plot = map_specific_damage, width = 6, height = 5, dpi = 300)
      
      # Dodaj nowy arkusz dla ubezpieczyciela i wstaw obie mapki
      addWorksheet(workbook, sheetName = nazwa_ubezpieczyciela)
      
      # Wstaw mapę specyficzną
      insertImage(workbook, sheet = nazwa_ubezpieczyciela, file = temp_file_specific, width = 20, height = 10, startRow = 1, startCol = 1)
      
      # Wstaw mapę ogólną poniżej
      insertImage(workbook, sheet = nazwa_ubezpieczyciela, file = temp_file_all, width = 20, height = 10, startRow = 53, startCol = 1)
    }
  }
  
  # Zapisz workbook do pliku Excel
  saveWorkbook(workbook, paste0(sciezka_glowna,"/Budynki_podsumowanie.xlsx"), overwrite = TRUE)
}

# Wywołanie funkcji z podaną ścieżką do głównego folderu
#sciezka_glowna <- "C/szczkr/test:/Users"
sciezka_glowna <- "I:/WOM/Sprawy_bieżące/Model ryzyka pożaru/Model YE2023/2_dane od ZU/5_czynne na 2023.12.31/2_po_geokodowaniu"
wczytaj_i_generuj_mapy(sciezka_glowna)



